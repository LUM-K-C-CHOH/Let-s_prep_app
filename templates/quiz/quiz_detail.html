{% extends "base.html" %}

{% block title %}{{ session.title }} — LET'S PREP{% endblock %}

{% block content %}
<div class="question-layout">
  <!-- Left: question area -->
  <section class="lp-card">
    <div class="lp-card-header">
      <div>
        <div class="lp-card-title">{{ session.title }}</div>
        <div class="lp-card-subtitle">
          {{ session.get_question_type_display }} •
          Question <span id="current-question-number">1</span> of {{ questions|length }}
        </div>
      </div>
      <span class="lp-hero-card-pill">
        ✨ AI-powered when available
      </span>
    </div>

    {% for q in questions %}
      <article class="question-card{% if forloop.first %} active{% endif %}"
               data-index="{{ forloop.counter0 }}"
               data-qtype="{{ q.question_type }}"
               data-explanation="{{ q.explanation|default_if_none:''|escape }}">
        <p class="quiz-question-text">
          {{ q.prompt|linebreaksbr }}
        </p>

        {% if q.question_type == "mcq" %}
          <div class="mcq-options" data-correct="{{ q.correct_option }}">
            {% if q.option_a %}
              <div class="mcq-option" data-option="A">
                <div class="mcq-option-label">A</div>
                <div class="mcq-option-text">{{ q.option_a }}</div>
              </div>
            {% endif %}
            {% if q.option_b %}
              <div class="mcq-option" data-option="B">
                <div class="mcq-option-label">B</div>
                <div class="mcq-option-text">{{ q.option_b }}</div>
              </div>
            {% endif %}
            {% if q.option_c %}
              <div class="mcq-option" data-option="C">
                <div class="mcq-option-label">C</div>
                <div class="mcq-option-text">{{ q.option_c }}</div>
              </div>
            {% endif %}
            {% if q.option_d %}
              <div class="mcq-option" data-option="D">
                <div class="mcq-option-label">D</div>
                <div class="mcq-option-text">{{ q.option_d }}</div>
              </div>
            {% endif %}
          </div>

        {% elif q.question_type == "flashcard" %}
          <div class="flashcard">
            <div class="flashcard-front">
              <strong>Tap to reveal answer</strong>
              <div class="lp-help-text">Use this as a self-testing card.</div>
            </div>
            <div class="flashcard-back">
              {{ q.answer_text|linebreaksbr }}
            </div>
          </div>

        {% else %}
          <!-- short answer / fill blank -->
          <div style="margin-top:0.9rem;">
            <label class="lp-form-row">
              <span>Your answer</span>
              <input type="text"
                     class="short-answer-input"
                     data-correct="{{ q.answer_text|default_if_none:''|escape }}">
            </label>
            <button type="button"
                    class="lp-btn lp-btn-small check-answer-btn">
              Check answer
            </button>
          </div>
        {% endif %}

        <p class="question-feedback"></p>
        <p class="question-ai-hint lp-help-text"></p>
      </article>
    {% endfor %}

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1.2rem;">
      <div>
        <button id="prev-question" class="lp-btn lp-btn-small lp-btn-ghost">Previous</button>
        <button id="next-question" class="lp-btn lp-btn-small" style="margin-left:0.3rem;">
          Next
        </button>
      </div>
      <a href="{% url 'history' %}" class="lp-nav-link" style="background:#e5e7eb;color:#111827;">
        Back to history
      </a>
    </div>
  </section>

  <!-- Right: side panel -->
  <aside class="quiz-side-panel">
    <div class="quiz-side-title">Session overview</div>
    <div class="quiz-meta">
      {{ session.created_at|date:"M d, Y H:i" }} • {{ session.num_questions }} questions
    </div>

    <div class="quiz-progress-track">
      <div class="quiz-progress-fill" id="quiz-progress-fill"></div>
    </div>
    <div style="font-size:0.78rem;margin-bottom:0.9rem;">
      Question <span id="progress-current">1</span> / {{ questions|length }}
    </div>

    <div style="font-size:0.8rem;color:#9ca3af;">
      Tip: Use ← → arrow keys to move between questions.
    </div>
  </aside>
</div>

<script>
(function() {
  const cards = Array.from(document.querySelectorAll('.question-card'));
  if (!cards.length) return;

  const prevBtn = document.getElementById('prev-question');
  const nextBtn = document.getElementById('next-question');
  const currentNumberSpan = document.getElementById('current-question-number');
  const progressCurrentSpan = document.getElementById('progress-current');
  const progressFill = document.getElementById('quiz-progress-fill');

  // Where to go when the quiz is finished
  const finishUrl = "{% url 'dashboard' %}";   // change to 'new_quiz' if you prefer

  let currentIndex = 0;
  const total = cards.length;

  function showCard(index) {
    cards.forEach((card, i) => {
      if (i === index) {
        card.style.display = 'block';
        card.classList.remove('active');
        void card.offsetWidth;          // restart CSS animation
        card.classList.add('active');
      } else {
        card.style.display = 'none';
        card.classList.remove('active');
      }
    });

    currentIndex = index;

    if (currentNumberSpan) currentNumberSpan.textContent = (index + 1).toString();
    if (progressCurrentSpan) progressCurrentSpan.textContent = (index + 1).toString();

    if (prevBtn) prevBtn.disabled = (index === 0);

    if (nextBtn) {
      if (index === total - 1) {
        nextBtn.textContent = "Done";
      } else {
        nextBtn.textContent = "Next";
      }
    }

    if (progressFill) {
      const pct = ((index + 1) / total) * 100;
      progressFill.style.width = pct + "%";
    }
  }

  // Behaviour per card
  cards.forEach((card) => {
    const qType = card.getAttribute('data-qtype');
    const explanationText = card.getAttribute('data-explanation') || '';
    const aiHint = card.querySelector('.question-ai-hint');

    // MCQ
    if (qType === 'mcq') {
      const options = card.querySelectorAll('.mcq-option');
      const correct = card.querySelector('.mcq-options')?.getAttribute('data-correct') || '';
      const feedback = card.querySelector('.question-feedback');

      options.forEach(opt => {
        opt.addEventListener('click', () => {
          if (!correct) return;
          const picked = opt.getAttribute('data-option');

          options.forEach(o => o.classList.remove('correct', 'incorrect'));

          if (picked === correct) {
            opt.classList.add('correct');
            if (feedback) {
              feedback.textContent = "✅ Correct!";
              feedback.classList.add('feedback-correct');
              feedback.classList.remove('feedback-incorrect');
            }
          } else {
            opt.classList.add('incorrect');
            options.forEach(o => {
              if (o.getAttribute('data-option') === correct) {
                o.classList.add('correct');
              }
            });
            if (feedback) {
              feedback.textContent = "❌ Not quite.";
              feedback.classList.add('feedback-incorrect');
              feedback.classList.remove('feedback-correct');
            }
          }

          if (aiHint && explanationText) {
            aiHint.textContent = "AI hint: " + explanationText;
          }
        });
      });
    }

    // Flashcard
    const flashcard = card.querySelector('.flashcard');
    if (flashcard) {
      flashcard.addEventListener('click', () => {
        flashcard.classList.toggle('flipped');
      });
    }

    // Short answer / fill-blank
    const input = card.querySelector('.short-answer-input');
    const checkBtn = card.querySelector('.check-answer-btn');
    const feedback = card.querySelector('.question-feedback');
    const correctAnswer = input ? (input.getAttribute('data-correct') || '') : '';

    function checkShortAnswer() {
      if (!input || !feedback) return;
      const given = (input.value || '').trim().toLowerCase();
      const expected = (correctAnswer || '').trim().toLowerCase();

      if (!expected) {
        feedback.textContent = "No stored answer for this question.";
        return;
      }

      if (given === expected) {
        feedback.textContent = "✅ Correct!";
        feedback.classList.add('feedback-correct');
        feedback.classList.remove('feedback-incorrect');
      } else {
        feedback.textContent = "❌ Not quite. Correct answer: " + correctAnswer;
        feedback.classList.add('feedback-incorrect');
        feedback.classList.remove('feedback-correct');
      }

      if (aiHint && explanationText) {
        aiHint.textContent = "AI hint: " + explanationText;
      }
    }

    if (checkBtn) {
      checkBtn.addEventListener('click', checkShortAnswer);
    }
    if (input) {
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          checkShortAnswer();
        }
      });
    }
  });

  // Navigation
  if (prevBtn) {
    prevBtn.addEventListener('click', () => {
      if (currentIndex > 0) showCard(currentIndex - 1);
    });
  }

  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      if (currentIndex < total - 1) {
        showCard(currentIndex + 1);
      } else {
        // Last question -> dashboard (or new_quiz)
        window.location.href = finishUrl;
      }
    });
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight' && currentIndex < total - 1) {
      showCard(currentIndex + 1);
    } else if (e.key === 'ArrowLeft' && currentIndex > 0) {
      showCard(currentIndex - 1);
    }
  });

  // Start
  showCard(0);
})();
</script>
{% endblock %}