{% extends "base.html" %}

{% block title %}{{ session.title }} — LET'S PREP{% endblock %}

{% block content %}
<div id="quiz-app" data-total="{{ questions|length }}">
  <div class="question-layout">
    <!-- LEFT: main quiz card -->
    <section class="lp-card">
      <div class="lp-card-header">
        <div>
          <div class="lp-card-title">{{ session.title }}</div>
          <div class="lp-card-subtitle">
            {{ session.get_question_type_display }} •
            Question <span id="current-number">1</span> of {{ questions|length }}
          </div>
        </div>
        <div class="quiz-header-right">
          <span class="lp-hero-card-pill">
            ✨ AI-powered when available
          </span>
          <div>
            Score: <strong><span id="score">0</span></strong>
          </div>
        </div>
      </div>

      {% for q in questions %}
        <article class="question-card{% if forloop.first %} active{% endif %}"
                 data-index="{{ forloop.counter0 }}"
                 data-qtype="{{ q.question_type }}"
                 data-answer-text="{{ q.answer_text|default_if_none:''|escapejs }}"
                 data-explanation="{{ q.explanation|default_if_none:''|escapejs }}">
          <p class="quiz-question-text">
            {{ q.prompt|linebreaksbr }}
          </p>

          {% if q.question_type == "mcq" %}
            <div class="mcq-options" data-correct="{{ q.correct_option }}">
              {% if q.option_a %}
                <button type="button" class="mcq-option" data-letter="A">
                  <span class="mcq-option-label">A</span>
                  <span class="mcq-option-text">{{ q.option_a }}</span>
                </button>
              {% endif %}
              {% if q.option_b %}
                <button type="button" class="mcq-option" data-letter="B">
                  <span class="mcq-option-label">B</span>
                  <span class="mcq-option-text">{{ q.option_b }}</span>
                </button>
              {% endif %}
              {% if q.option_c %}
                <button type="button" class="mcq-option" data-letter="C">
                  <span class="mcq-option-label">C</span>
                  <span class="mcq-option-text">{{ q.option_c }}</span>
                </button>
              {% endif %}
              {% if q.option_d %}
                <button type="button" class="mcq-option" data-letter="D">
                  <span class="mcq-option-label">D</span>
                  <span class="mcq-option-text">{{ q.option_d }}</span>
                </button>
              {% endif %}
            </div>

          {% elif q.question_type == "flashcard" %}
            <div class="flashcard">
              <div class="flashcard-front">
                <strong>Tap to reveal answer</strong>
                <div class="lp-help-text">Use this as a self-testing card.</div>
              </div>
              <div class="flashcard-back">
                {{ q.answer_text }}
              </div>
            </div>

          {% else %}
            <!-- short answer / fill in the blank -->
            <div style="margin-top:0.9rem;">
              <div class="lp-form-row">
                <label>Your answer</label>
                <input type="text" class="short-answer-input"
                       placeholder="Type your answer here…">
              </div>
              <button type="button" class="lp-btn lp-btn-small reveal-answer">
                Check answer
              </button>
              <div class="answer-revealed" style="margin-top:0.4rem;font-size:0.85rem;"></div>
            </div>
          {% endif %}

          <div class="question-feedback"></div>
          <div class="ai-explanation" style="display:none;font-size:0.8rem;margin-top:0.2rem;"></div>
        </article>
      {% endfor %}

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1.2rem;">
        <div>
          <button id="prev-btn" class="lp-btn lp-btn-small lp-btn-ghost">Previous</button>
          <button id="next-btn" class="lp-btn lp-btn-small" style="margin-left:0.3rem;">Next</button>
        </div>
        <a href="{% url 'history' %}" class="lp-nav-link" style="background:#e5e7eb;color:#111827;">
          Back to history
        </a>
      </div>
    </section>

    <!-- RIGHT: progress side panel -->
    <aside class="quiz-side-panel">
      <div class="quiz-side-title">Session overview</div>
      <div class="quiz-meta">
        {{ session.created_at|date:"M d, Y H:i" }} • {{ session.num_questions }} questions
      </div>

      <div class="quiz-progress-track">
        <div class="quiz-progress-fill" id="progress-fill"></div>
      </div>
      <div style="font-size:0.78rem;margin-bottom:0.9rem;">
        Question <span id="progress-current">1</span> / {{ questions|length }}
      </div>

      <div style="font-size:0.8rem;color:#9ca3af;">
        Tip: Use ← → arrow keys to move between questions.
      </div>
    </aside>
  </div>
</div>

<script>
(function() {
  const container = document.getElementById('quiz-app');
  if (!container) return;

  const cards = Array.from(document.querySelectorAll('.question-card'));
  if (!cards.length) return;

  let currentIndex = 0;
  let score = 0;

  const total = parseInt(container.dataset.total, 10) || cards.length;
  const scoreSpan = document.getElementById('score');
  const currentNumberSpan = document.getElementById('current-number');
  const progressCurrentSpan = document.getElementById('progress-current');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const progressFill = document.getElementById('progress-fill');

  function showCard(index) {
    cards.forEach((card, i) => {
      if (i === index) {
        card.style.display = 'block';
        card.classList.remove('active');
        void card.offsetWidth; // restart CSS animation
        card.classList.add('active');
      } else {
        card.style.display = 'none';
        card.classList.remove('active');
      }
    });

    currentIndex = index;
    const num = index + 1;
    if (currentNumberSpan) currentNumberSpan.textContent = String(num);
    if (progressCurrentSpan) progressCurrentSpan.textContent = String(num);

    prevBtn.disabled = (index === 0);
    nextBtn.disabled = (index === cards.length - 1);

    if (progressFill) {
      const progress = (num / total) * 100;
      progressFill.style.width = progress + '%';
    }
  }

  // Attach behaviour to each question card
  cards.forEach((card) => {
    const qtype = card.dataset.qtype;
    const explanation = (card.dataset.explanation || '').trim();
    const answerText = (card.dataset.answerText || '').trim();

    const feedbackEl = card.querySelector('.question-feedback');
    const aiEl = card.querySelector('.ai-explanation');

    if (feedbackEl) {
      feedbackEl.textContent = '';
    }
    if (aiEl) {
      aiEl.style.display = 'none';
      aiEl.textContent = '';
    }

    // MCQ logic
    if (qtype === 'mcq') {
      const options = Array.from(card.querySelectorAll('.mcq-option'));
      const optionsContainer = card.querySelector('.mcq-options');
      if (!optionsContainer || !options.length || !feedbackEl) return;

      const correct = optionsContainer.getAttribute('data-correct') || '';
      let answered = false;

      options.forEach(btn => {
        btn.addEventListener('click', () => {
          if (answered) return;
          const picked = btn.getAttribute('data-letter');

          options.forEach(o => o.classList.remove('correct', 'incorrect'));

          if (picked === correct) {
            btn.classList.add('correct');
            feedbackEl.textContent = '✅ Nice! That matches the notes.';
            feedbackEl.classList.remove('feedback-incorrect');
            feedbackEl.classList.add('feedback-correct');
            score += 1;
            if (scoreSpan) scoreSpan.textContent = String(score);
          } else {
            btn.classList.add('incorrect');
            feedbackEl.textContent = '❌ Not quite. Correct answer: ' + correct;
            feedbackEl.classList.remove('feedback-correct');
            feedbackEl.classList.add('feedback-incorrect');

            options.forEach(o => {
              if (o.getAttribute('data-letter') === correct) {
                o.classList.add('correct');
              }
            });

            if (aiEl && explanation) {
              aiEl.style.display = 'block';
              aiEl.textContent = 'AI hint: ' + explanation;
            }
          }
          answered = true;
        });
      });
    }

    // Flashcard logic
    if (qtype === 'flashcard') {
      const flashcard = card.querySelector('.flashcard');
      if (flashcard) {
        flashcard.addEventListener('click', () => {
          flashcard.classList.toggle('flipped');
        });
      }
    }

    // Short-answer / fill_blank logic
    if (qtype !== 'mcq' && qtype !== 'flashcard') {
      const input = card.querySelector('.short-answer-input');
      const btn = card.querySelector('.reveal-answer');
      const result = card.querySelector('.answer-revealed');
      if (!input || !btn || !result) return;

      btn.addEventListener('click', () => {
        const correctAns = answerText;
        const given = (input.value || '').trim();

        if (!correctAns) {
          result.textContent = 'Answer: (no stored answer text).';
          return;
        }

        if (!given) {
          result.textContent = 'Answer: ' + correctAns;
          return;
        }

        if (given.toLowerCase() === correctAns.toLowerCase()) {
          result.textContent = '✅ Correct! Answer: ' + correctAns;
        } else {
          result.textContent = '❌ Not quite. Correct answer: ' + correctAns;
          if (aiEl && explanation) {
            aiEl.style.display = 'block';
            aiEl.textContent = 'AI hint: ' + explanation;
          }
        }
      });
    }
  });

  prevBtn.addEventListener('click', () => {
    if (currentIndex > 0) showCard(currentIndex - 1);
  });

  nextBtn.addEventListener('click', () => {
    if (currentIndex < cards.length - 1) showCard(currentIndex + 1);
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight' && currentIndex < cards.length - 1) {
      showCard(currentIndex + 1);
    } else if (e.key === 'ArrowLeft' && currentIndex > 0) {
      showCard(currentIndex - 1);
    }
  });

  showCard(0);
})();
</script>
{% endblock %}